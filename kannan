#!/usr/bin/env bash
# Kannan — Adaptive Multi-Agent Development Environment
# Named after Krishna (Kannan in Tamil), the divine strategist and guide
set -euo pipefail

# Bash 4+ required for associative arrays (declare -A)
if [[ "${BASH_VERSINFO[0]}" -lt 4 ]]; then
    echo "ERROR: kannan requires bash 4+, but you have bash ${BASH_VERSION}" >&2
    if [[ "$(uname -s)" == "Darwin" ]]; then
        echo "  macOS ships bash 3.2. Install a newer version:" >&2
        echo "    brew install bash" >&2
        echo "  Then either restart your terminal or run:" >&2
        echo "    export PATH=\"/opt/homebrew/bin:\$PATH\"" >&2
    else
        echo "  Install bash 4+ via your package manager." >&2
    fi
    exit 1
fi

KANNAN_VERSION="0.1.0"
KANNAN_DIR=".kannan"
# Resolve through symlinks to find the real install location
_resolve_script_dir() {
    local source="${BASH_SOURCE[0]}"
    while [[ -L "$source" ]]; do
        local dir
        dir="$(cd -P "$(dirname "$source")" && pwd)"
        source="$(readlink "$source")"
        # Resolve relative symlinks
        [[ "$source" != /* ]] && source="$dir/$source"
    done
    cd -P "$(dirname "$source")" && pwd
}
SCRIPT_DIR="$(_resolve_script_dir)"

# Source all library modules
source "$SCRIPT_DIR/lib/util.sh"
source "$SCRIPT_DIR/lib/repo.sh"
source "$SCRIPT_DIR/lib/agents.sh"
source "$SCRIPT_DIR/lib/roles.sh"
source "$SCRIPT_DIR/lib/consensus.sh"
source "$SCRIPT_DIR/lib/ui.sh"
source "$SCRIPT_DIR/lib/config.sh"
source "$SCRIPT_DIR/lib/memory.sh"
source "$SCRIPT_DIR/lib/runtime.sh"

# --- Commands ---

cmd_version() {
    echo "kannan v${KANNAN_VERSION}"
}

cmd_dev() {
    local dir="."
    local prompt=""

    # Parse flags
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -p|--prompt)
                prompt="$2"
                shift 2
                ;;
            *)
                dir="$1"
                shift
                ;;
        esac
    done

    dir="$(cd "$dir" && pwd)"

    ui_banner
    ui_info "Working directory: $dir"

    # Initialize .kannan state directory
    kannan_init "$dir"

    # Phase 1: Understand the repository
    ui_phase "Analyzing repository..."
    repo_analyze "$dir"

    # Phase 2: Discover available agents
    ui_phase "Discovering agents..."
    agents_discover

    local agent_count
    agent_count="$(agents_available_count)"
    if [[ "$agent_count" -eq 0 ]]; then
        ui_error "No agents found. Install at least one of: claude, codex, gemini, ollama"
        exit 1
    fi
    ui_success "Found $agent_count agent(s): $(agents_available_names)"

    # Phase 2.5: Load config (after agents so we can validate pinned assignments)
    config_load "$dir"
    config_apply

    # Phase 2.6: Greenfield detection
    if repo_is_greenfield "$dir"; then
        ui_greenfield_bootstrap
        repo_set_greenfield_prefs "$dir" \
            "$_GREENFIELD_LANGUAGE" \
            "$_GREENFIELD_FRAMEWORK" \
            "$_GREENFIELD_DESCRIPTION"
    fi

    # Phase 3: Execute
    if [[ -n "$prompt" ]]; then
        # Single-shot mode: run once and exit
        runtime_once "$dir" "$prompt"
    else
        # Interactive loop
        ui_phase "Ready for instructions"
        echo ""
        runtime_loop "$dir"
    fi
}

cmd_agent_list() {
    agents_discover
    agents_list_pretty
}

cmd_agent_test() {
    local name="${1:?Usage: kannan agent test <name>}"
    agents_discover
    if ! agents_is_available "$name"; then
        ui_error "Agent '$name' is not available"
        exit 1
    fi
    ui_info "Testing agent: $name"
    adapter_execute "$name" "" "Respond with exactly: Hello from $name" 2>/dev/null
}

cmd_usage() {
    local subcmd="${1:-}"

    case "$subcmd" in
        global)
            memory_usage_global
            ;;
        clear)
            if ui_confirm "Clear global usage log?"; then
                rm -f "$KANNAN_GLOBAL_DIR/usage.jsonl"
                ui_success "Global usage log cleared"
            else
                ui_info "Cancelled"
            fi
            ;;
        *)
            # Project-local usage (default)
            local dir="${subcmd:-.}"
            dir="$(cd "$dir" && pwd)"
            memory_usage_table "$dir"
            ;;
    esac
}

cmd_memory_show() {
    local dir="${1:-.}"
    dir="$(cd "$dir" && pwd)"
    memory_show "$dir"
}

cmd_memory_clear() {
    local dir="${1:-.}"
    dir="$(cd "$dir" && pwd)"
    if ui_confirm "Clear all project memory for $dir?"; then
        memory_clear "$dir"
    else
        ui_info "Cancelled"
    fi
}

cmd_help() {
    cat <<EOF
Kannan v${KANNAN_VERSION} — Adaptive Multi-Agent Development Environment

Usage:
  kannan dev [dir]                Start interactive session (default: current dir)
  kannan dev [dir] -p "intent"    Run a single intent and exit
  kannan agent list               List available agents
  kannan agent test <name>        Test an agent with a simple prompt
  kannan config init [dir]        Generate a starter .kannan/config.json
  kannan usage [dir]               Show project token usage per agent
  kannan usage global             Show global usage across all projects
  kannan usage clear              Clear global usage log
  kannan memory show [dir]        Show project memory (sessions, patterns, stats)
  kannan memory clear [dir]       Clear project memory
  kannan version                  Print version
  kannan help                     Show this help

Options:
  -p, --prompt "text"    Run a single intent non-interactively

Examples:
  cd my-project && kannan dev
  kannan dev /path/to/repo
  kannan dev -p "add input validation to the login form"
  kannan dev /path/to/repo -p "fix the failing tests"
  kannan memory show
  kannan agent list
EOF
}

# --- Main ---

main() {
    local cmd="${1:-help}"
    shift || true

    case "$cmd" in
        dev)          cmd_dev "$@" ;;
        agent)
            local subcmd="${1:-list}"
            shift || true
            case "$subcmd" in
                list) cmd_agent_list ;;
                test) cmd_agent_test "$@" ;;
                *)    ui_error "Unknown agent command: $subcmd"; cmd_help; exit 1 ;;
            esac
            ;;
        config)
            local subcmd="${1:-help}"
            shift || true
            case "$subcmd" in
                init) config_init "$@" ;;
                *)    echo "Usage: kannan config init [dir]"; exit 1 ;;
            esac
            ;;
        memory)
            local subcmd="${1:-show}"
            shift || true
            case "$subcmd" in
                show)  cmd_memory_show "$@" ;;
                clear) cmd_memory_clear "$@" ;;
                *)     echo "Usage: kannan memory show|clear [dir]"; exit 1 ;;
            esac
            ;;
        usage)        cmd_usage "$@" ;;
        version)      cmd_version ;;
        help|--help)  cmd_help ;;
        *)            ui_error "Unknown command: $cmd"; cmd_help; exit 1 ;;
    esac
}

main "$@"
